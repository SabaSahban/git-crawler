import subprocess
import json
import logging
import os


def run_vulnerability_scan(scan_dir):
    logging.info(f"Running vulnerability scan on {scan_dir}")
    try:
        result = subprocess.run(["semgrep", "--config=p/r2c-security-audit", "--json", scan_dir], capture_output=True,
                                text=True)
        if result.returncode in [0, 1]:  # Semgrep returns 1 when findings are detected
            findings = json.loads(result.stdout)
            findings_path = os.path.join(scan_dir, "semgrep_findings.json")
            with open(findings_path, 'w') as findings_file:
                json.dump(findings, findings_file, indent=4)
            logging.info(f"Vulnerability scan findings saved to {findings_path}")
        else:
            logging.error("Error running Semgrep scan.")
    except Exception as e:
        logging.error(f"Exception during Semgrep scan: {e}")
